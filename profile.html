<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мій профіль | Easy Body Food</title>
    <link rel="icon" type="image/png" href="assets/img/logo.png">
    <link rel="stylesheet" href="assets/css/header.css">
    <link rel="stylesheet" href="assets/css/footer.css">
    <link rel="stylesheet" href="assets/css/profile.css">
</head>
<body>
    <div id="header"></div>
    <main style="background:#fff;">
        <section style="padding: 40px 0 0 0; max-width: 1200px; margin: 0 auto;">
            <h1 class="profile-header-title">Мій профіль</h1>
            <div class="profile-main-row">
                <div class="profile-avatar-block">
                    <img src="assets/img/user1.png" alt="Avatar" class="profile-avatar-img">
                    <div class="profile-avatar-btns">
                        <button class="profile-btn-main" id="save-profile-btn">Змінити</button>
                        <button class="profile-btn-danger" id="logout-btn">Вийти</button> 
                    </div>
                </div>
                <form class="profile-form">
                    <div class="profile-form-row">
                        <div style="flex:1;">
                            <div class="profile-label">Ім'я <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                            <input class="profile-input" id="firstname-input" type="text" value="">
                            <div class="profile-error" id="firstname-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                        </div>
                        <div style="flex:1;">
                            <div class="profile-label">Прізвище <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                            <input class="profile-input" id="lastname-input" type="text" value="">
                            <div class="profile-error" id="lastname-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                        </div>
                    </div>
                    <div>
                        <div class="profile-label">Телефон <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                        <input class="profile-input" id="phone-input" type="tel" value="">
                        <div class="profile-error" id="phone-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                    </div>
                    <div>
                        <div class="profile-label">Email <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                        <input class="profile-input" id="email-input" type="email" value="">
                        <div class="profile-error" id="email-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                    </div>
                    <div>
                        <div class="profile-label">Стать <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                        <select class="profile-input" id="gender-input">
                            <option value="female">Жіноча</option>
                            <option value="male">Чоловіча</option>
                        </select>
                        <div class="profile-error" id="gender-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                    </div>
                    <div>
                        <div class="profile-label">Алергени <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                        <input class="profile-input" id="allergens-input" type="text" placeholder="Вкажіть ваші алергени, якщо є">
                    </div>
                    <div>
                        <div class="profile-label">Місто <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                        <select class="profile-input" id="city-input">
                            <option value="Київ">Київ</option>
                        </select>
                    </div>
                    <div class="profile-form-row">
                        <div style="flex:1;">
                            <div class="profile-label">Telegram <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                            <input class="profile-input" id="telegram-input" type="text" value="">
                            <div class="profile-error" id="telegram-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                        </div>
                        <div style="flex:1;">
                            <div class="profile-label">Instagram <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                            <input class="profile-input" id="instagram-input" type="text" value="">
                            <div class="profile-error" id="instagram-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                        </div>
                    </div>
                    <div class="profile-label" style="margin-top:12px;">Адреса доставки:</div>
                    <div>
                        <div class="profile-label">Вулиця <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                        <input class="profile-input" id="street-input" type="text" value="">
                        <div class="profile-error" id="street-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                    </div>
                    <div class="profile-form-row">
                        <div style="flex:1;">
                            <div class="profile-label">Будинок <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                            <input class="profile-input" id="house-input" type="text" value="">
                            <div class="profile-error" id="house-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                        </div>
                        <div style="flex:1;">
                            <div class="profile-label">Поверх <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                            <input class="profile-input" id="floor-input" type="text" value="">
                            <div class="profile-error" id="floor-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                        </div>
                        <div style="flex:1;">
                            <div class="profile-label">Квартира <svg class="profile-edit-icon" width="18" height="18" viewBox="0 0 20 20"><path d="M14.846 2.854a2.5 2.5 0 0 1 3.536 3.535l-9.193 9.193a2 2 0 0 1-.707.464l-3.25 1.083a.5.5 0 0 1-.632-.632l1.083-3.25a2 2 0 0 1 .464-.707l9.193-9.193Zm2.122 1.414a1.5 1.5 0 0 0-2.122 0l-9.193 9.193a1 1 0 0 0-.232.354l-.89 2.67 2.67-.89a1 1 0 0 0 .354-.232l9.193-9.193a1.5 1.5 0 0 0 0-2.122Z" fill="#bdbdbd"/></svg></div>
                            <input class="profile-input" id="apartment-input" type="text" value="">
                            <div class="profile-error" id="apartment-error" style="display:none;">Поле є обов'язковим для відправки інформації!</div>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        <section style="max-width:1200px;margin:0 auto;">
            <div class="profile-tabs" id="profileTabs">
                <button class="profile-tab active" data-tab="cart">Кошик</button>
                <button class="profile-tab" data-tab="favorites">Улюблені страви</button>
                <button class="profile-tab" data-tab="templates">Збережені шаблони</button>
                <button class="profile-tab" data-tab="history">Історія замовлень</button>
            </div>
            <div id="tab-cart" class="profile-tab-content" style="display:block;">
                <div class="profile-cart-title">Кошик</div>
                <div class="profile-cart-empty">
                    <div class="profile-cart-empty-title">Упс! Кошик порожній</div>
                    <div class="profile-cart-empty-desc">Саме час для правильного харчування!</div>
                    <div class="profile-cart-btns">
                        <button class="profile-cart-btn">Конструктор меню</button>
                        <button class="profile-cart-btn">Зіркове меню</button>
                    </div>
                </div>
            </div>
            <div id="tab-favorites" class="profile-tab-content" style="display:none;">
                <div class="profile-cart-title">Улюблені страви</div>
                <div class="profile-cart-empty" style="background:#f8fff8;color:#36b23a;">
                    Тут будуть ваші улюблені страви.
                </div>
            </div>
            <div id="tab-templates" class="profile-tab-content" style="display:none;">
                <div class="profile-cart-title">Збережені шаблони</div>
                <div class="profile-cart-empty" style="background:#f8fff8;color:#36b23a;">
                    Тут будуть ваші шаблони меню.
                </div>
            </div>
            <div id="tab-history" class="profile-tab-content" style="display:none;">
                <div class="profile-cart-title">Історія замовлень</div>
                <div class="profile-cart-empty" style="background:#f8fff8;color:#36b23a;">
                    Тут буде історія ваших замовлень.
                </div>
            </div>
        </section>
    </main>
    <div id="footer"></div>
    <script src="assets/js/layout.js"></script>
    <script>
    // Переключение вкладок профиля
    document.querySelectorAll('.profile-tab').forEach(function(tabBtn) {
        tabBtn.addEventListener('click', function() {
            document.querySelectorAll('.profile-tab').forEach(function(btn){btn.classList.remove('active');});
            tabBtn.classList.add('active');
            var tab = tabBtn.getAttribute('data-tab');
            document.querySelectorAll('.profile-tab-content').forEach(function(content){
                content.style.display = 'none';
            });
            document.getElementById('tab-' + tab).style.display = 'block';
        });
    });
    // Валидация всех обязательных полей
    const requiredFields = [
        {input: 'firstname-input', error: 'firstname-error'},
        {input: 'lastname-input', error: 'lastname-error'},
        {input: 'phone-input', error: 'phone-error'},
        {input: 'email-input', error: 'email-error'},
        {input: 'gender-input', error: 'gender-error'},
        {input: 'telegram-input', error: 'telegram-error'},
        {input: 'instagram-input', error: 'instagram-error'},
        {input: 'street-input', error: 'street-error'},
        {input: 'house-input', error: 'house-error'},
        {input: 'floor-input', error: 'floor-error'},
        {input: 'apartment-input', error: 'apartment-error'}
    ];
    requiredFields.forEach(({input, error}) => {
        const inputEl = document.getElementById(input);
        const errorEl = document.getElementById(error);
        if (!inputEl || !errorEl) return;
        inputEl.addEventListener('blur', function() {
            if (!inputEl.value.trim()) {
                errorEl.style.display = 'block';
            } else {
                errorEl.style.display = 'none';
            }
        });
        inputEl.addEventListener('input', function() {
            if (inputEl.value.trim()) {
                errorEl.style.display = 'none';
            }
        });
    });
    document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '../EaseBodyFoodSite/index.html'; // Измените путь, если у вас другая страница входа
    });

    // Обработчик для кнопки "Змінити" - сохранение профиля
    document.getElementById('save-profile-btn').addEventListener('click', function() {
        const userId = localStorage.getItem('userId');
        // Собираем данные из формы
        const profileData = {
            firstName: document.getElementById('firstname-input').value,
            lastName: document.getElementById('lastname-input').value,
            number: document.getElementById('phone-input').value,
            email: document.getElementById('email-input').value,
            gender: document.getElementById('gender-input').value === 'male' ? 'Мужской' : 'Женский',
            allergies: document.getElementById('allergens-input').value
        };
        const addressData = {};
        const street = document.getElementById('street-input').value;
        const house = document.getElementById('house-input').value;
        const apartment = document.getElementById('apartment-input').value;
        const floorValue = document.getElementById('floor-input').value;
        
        if (street) addressData.Street = street;
        if (house) addressData.House = house ? parseInt(house) : undefined;
        if (apartment) addressData.Apartment = apartment;
        
        // Добавляем город
        const city = document.getElementById('city-input').value;
        if (city) addressData.Sity = city;
        
        if (floorValue) {
            const match = floorValue.match(/Підʼїзд (\d+)/);
            if (match) {
                addressData.Enterence = parseInt(match[1]);
            }
        }
        
        // Убираем дату - пусть сервер сам устанавливает в UTC
        // addressData.Date = new Date().toISOString();

        const socialsData = {
            telegram: document.getElementById('telegram-input').value,
            instagram: document.getElementById('instagram-input').value
        };

        console.log('Отправляем данные профиля:', profileData);
        console.log('Отправляем данные адреса:', addressData);
        console.log('Отправляем данные соцсетей:', socialsData);
        console.log('JSON для адреса:', JSON.stringify(addressData));

        // Отправляем три запроса
        fetch('assets/js/settings.json')
            .then(response => response.json())
            .then(settings => {
                const baseUrl = settings.SERVER_BASE_URL;
                // Основная информация
                const infoPromise = fetch(baseUrl + '/user/addinfo?userId=' + userId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(profileData)
                });
                // Адрес
                const addressPromise = fetch(baseUrl + '/user/address?userId=' + userId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(addressData)
                }).then(response => {
                    console.log('Ответ сервера для адреса:', response.status, response.statusText);
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('Ошибка адреса - ответ сервера:', text);
                            throw new Error('Ошибка адреса: ' + text);
                        });
                    }
                    return response;
                });
                // Соцсети
                const socialsPromise = fetch(baseUrl + '/user/social?userId=' + userId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(socialsData)
                });
                return Promise.all([infoPromise, addressPromise, socialsPromise]);
            })
            .then(([infoRes, addressRes, socialsRes]) => {
                if (infoRes.ok && addressRes.ok && socialsRes.ok) {
                    alert('Профіль, адресу і соцмережі успішно оновлено!');
                } else {
                    let errorMsg = 'Помилка оновлення:';
                    if (!infoRes.ok) errorMsg += ' профілю;';
                    if (!addressRes.ok) errorMsg += ' адреси;';
                    if (!socialsRes.ok) errorMsg += ' соцмереж;';
                    throw new Error(errorMsg);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Помилка при оновленні: ' + error.message);
            });
    });

    // Загрузка данных профиля с сервера и заполнение формы
    // Сначала очищаем все поля профиля
    const clearProfileFields = () => {
        const ids = [
            'firstname-input', 'lastname-input', 'phone-input', 'email-input',
            'telegram-input', 'instagram-input', 'street-input', 'house-input',
            'floor-input', 'apartment-input', 'gender-input', 'allergens-input', 'city-input'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
    };
    clearProfileFields();
    fetch('assets/js/settings.json')
      .then(response => response.json())
      .then(settings => {
        const baseUrl = settings.SERVER_BASE_URL;
        console.log('Base URL:', baseUrl);
        
        // Здесь можно получить userID из localStorage/sessionStorage/cookie, если нужно
        const userId = localStorage.getItem('userId');
        console.log('UserID from localStorage:', userId);
        
        // Проверяем, что userId существует
        if (!userId) {
          console.error('userId не найден в localStorage');
          alert('Помилка: користувач не авторизований. Будь ласка, увійдіть в систему.');
          return;
        }
        
        const fullUrl = baseUrl + '/user/info/' + userId;
        console.log('Отправляем GET запрос на:', fullUrl);
        
        // Для примера просто делаем POST на /user/profile (так как GET не работает с ngrok)
        const xhr = new XMLHttpRequest();
        xhr.open('POST', fullUrl, true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                console.log('Получен ответ от сервера:', xhr.status, xhr.statusText);
                if (xhr.status === 200) {
                    try {
                        const data = JSON.parse(xhr.responseText);
                        console.log('Данные профиля получены:', data);
                        // Заполняем поля формы только если значение есть, иначе оставляем пустым
                        const setValue = (id, value) => {
                            const el = document.getElementById(id);
                            if (el) el.value = (value !== undefined && value !== null) ? value : '';
                        };
                        setValue('firstname-input', data.firstName);
                        setValue('lastname-input', data.lastName);
                        setValue('phone-input', data.number);
                        setValue('email-input', data.email);
                        setValue('telegram-input', data.telegram);
                        setValue('instagram-input', data.instagram);
                        setValue('street-input', data.street);
                        setValue('house-input', data.house);
                        setValue('apartment-input', data.apartment);
                        // Для пола (gender)
                        if (data.userSex === 'Мужской' || data.userSex === 'Чоловіча') {
                            setValue('gender-input', 'male');
                        } else if (data.userSex === 'Женский' || data.userSex === 'Жіноча') {
                            setValue('gender-input', 'female');
                        } else {
                            setValue('gender-input', '');
                        }
                        setValue('allergens-input', data.userAllergens);
                        // Для города
                        setValue('city-input', data.city);
                        // Для этажа (floor-input) — если entrance есть, иначе пусто
                        setValue('floor-input', data.entrance ? 'Підʼїзд ' + data.entrance : '');
                    } catch (e) {
                        console.error('Ошибка парсинга JSON:', e);
                        console.error('Полный ответ сервера:', xhr.responseText);
                    }
                } else {
                    console.error('Ошибка загрузки профиля:', xhr.status, xhr.statusText);
                }
            }
        };
        xhr.send(JSON.stringify({ userId: userId }));
      })
      .catch(err => {
        console.error('Ошибка загрузки settings.json:', err);
      });
    </script>
</body>
</html> 